{% extends 'base.html' %}

{% block title %}
     Maps
{% endblock %}

{% block subject %}
     <span id="title1">Maps</span>
{% endblock %}

{% block body %}

<select style="width:25%"; id="button_districts_map">
      <option></option>
</select>

<select style="width:25%"; id="button_counties_map">
      <option></option>
</select>

<select style="width:25%"; id="button_deposits_map" multiple ="multiple">
      <option></option>
</select>

<div id="cesiumContainer"></div>

<!-- *****************************************************************
LOADING PROGRESS ICON
***************************************************************** -->
<div id="wait" style="display:none;width:69px;height:89px;border:1px
     solid black;position:absolute;top:200px;
     left:50%;padding:2px;">
     <img src="{{url_for('static', filename='img/demo_wait.gif')}}"
          width="64" height="64" />
     <!-- <img src='demo_wait.gif' width="64" height="64" /> -->
     <br>Loading..
</div>

<script>

$(document).ready(function() {

  $("#wait").show();

  var index = 0
  var usrMapLabels_yn = 'n'

  //*************************************************************
  //   AJAX CALL TO RETRIEVE DISTRICTS
  //*************************************************************
  $.ajax({
     type: "GET",
     url: "http://127.0.0.1:5000/districts_all",
     success: function(data) {
          objects = JSON.parse(data.Districts)
          $.each(objects, function(i, object) {
               $temp = "<option " + "value="  + object.district_id + ">"
                    + object.district_name + '</option>'
               //console.log('Districts: ajax $temp ', $temp)
               $('#button_districts_map').append($temp);
          });
       }
   });

   //*************************************************************
   //   AJAX CALL TO RETRIEVE COUNTIES
   //*************************************************************
   $.ajax({
      type: "GET",
      url: "http://127.0.0.1:5000/counties_all",
      success: function(data) {
           objects = JSON.parse(data.Counties)
           $.each(objects, function(i, object) {
                var state_county = object.state + ' : ' + object.county
                var state_county_ids = object.state_id + ':' + object.county_id
                $temp = "<option " + "value="  + state_county_ids + ">"
                     + state_county + '</option>'
                //console.log('Counties: ajax $temp ', $temp)
                $('#button_counties_map').append($temp);
           });
        }
    });

    //*************************************************************
    //   AJAX CALL TO RETRIEVE DEPOSITS
    //*************************************************************
    $.ajax({
       type: "GET",
       url: "http://127.0.0.1:5000/deposits_all",
       success: function(data) {
            objects = JSON.parse(data.Deposits)
            $.each(objects, function(i, object) {
                 $temp = "<option " + "value="  + object.deposit_id + ">"
                      + object.deposit_name + '</option>'
                 index += 1
                 //console.log('Deposits: ajax $temp ', index, ': ',$temp)
                 $('#button_deposits_map').append($temp);
            });
         },
      complete: function(){
          $("#wait").hide();
        }
     });

//*************************************************************
//   BY_DISTRICT SELECTION
//*************************************************************
$selectElement =  $("#button_districts_map").select2({
  placeholder : 'Select a District'
});

$("#button_districts_map").change(function() {
     var selected_id = $(this).children("option:selected").val();
     //console.log('selected_id', selected_id)
     doAjax_getSessionOptions();
     doAjax_deposits_by_district(selected_id);
});

//*************************************************************
//   BY_COUNTY SELECTION
//*************************************************************
$selectElement =  $("#button_counties_map").select2({
  placeholder : 'Select a County'
});

$("#button_counties_map").change(function() {
     var selected_id = $(this).children("option:selected").val();
     //console.log('selected_id', selected_id)
     doAjax_getSessionOptions();
     doAjax_deposits_by_county(selected_id);
});

//*************************************************************
//   BY_DEPOSIT SELECTION
//*************************************************************
$selectElement =  $("#button_deposits_map").select2({
  placeholder : 'Select a Deposit',
  minimumInputLength: 2
});

$("#button_deposits_map").change(function() {
      var selected_ids = $("#button_deposits_map").val()
      doAjax_getSessionOptions();
      doAjax_deposits_by_deposit(selected_ids);
});


//*************************************************************
//AJAX CALL TO GET SESSION OPTIONS
//*************************************************************
var doAjax_getSessionOptions = function() {
     //console.log("doAjax_openModal");
     $.ajax({
        type: "GET",
        url: "http://127.0.0.1:5000/options_home",
        success: function(data) {
             usrMapLabels_yn = data.usrMapLabels_yn
          },
        complete: function(){
        }
    });
  }

//*************************************************************
//AJAX CALL TO RETRIEVE DEPOSIT COORDS FOR SELECTED DISTRICT,
//*************************************************************
var doAjax_deposits_by_district = function(inputValue) {
     //console.log("inputValue ", inputValue);
     var deposit_ids = []
     var deposit_names = []
     var lats = []
     var lons = []
     var labels = []
     var descriptions = []

     $.ajax({
        type: "GET",
        url: "http://127.0.0.1:5000/deposits_by_district/" + inputValue,
        success: function(data) {
            objects = JSON.parse(data.Deposits)
            $.each(objects, function(i, object) {
                  country = object.country
                  //console.log('country ', country)
                  county = object.county
                  deposit_id = JSON.stringify(object.deposit_id)
                  deposit_name = object.deposit_name
                  district_name = object.district_name
                  state = object.state
                  pounds_u3o8 = object.pounds_u3o8
                  grade = object.grade
                  database = object.database_name
                  description = country
                  if (state) {
                     description =  state + ', ' + description
                  }
                  if (county) {
                     description =  county + ' County, ' + description
                  }

                  description =  description + ' :Grade = ' + grade + ': Pounds U3O8 = ' + pounds_u3o8 + ' :Database = ' + database

                  label = deposit_id + ': ' + deposit_name +
                    ': ' + district_name

                  deposit_ids.push(deposit_id);
                  deposit_names.push(deposit_name);
                  descriptions.push(description)
                  lats.push(object.latitude);
                  lons.push(object.longitude);
                  labels.push(label);

            });
        },
         complete: function(){

             $('#cesiumContainer').empty()

             Cesium.Ion.defaultAccessToken = '{{CESIUM_API_KEY}}';
             var viewer = new Cesium.Viewer('cesiumContainer');
             var showText_tf = false
             if  (usrMapLabels_yn == 'y'){
               showText_tf = true
             }

             for (var i = 0; i < deposit_names.length; i++) {
                  //console.log('labels[i] ', labels[i])
                  var myDistrict = viewer.entities.add({
                      name : labels[i],
                      position : Cesium.Cartesian3.fromDegrees(lons[i], lats[i]),
                      point : {
                          pixelSize : 5,
                          color : Cesium.Color.RED,
                          outlineColor : Cesium.Color.WHITE,
                          outlineWidth : 2
                      },
                      description: descriptions[i],
                      label : {
                          //text : deposit_ids[i],
                          show: showText_tf,
                          text : deposit_names[i],
                          font : '14pt monospace',
                          style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                          outlineWidth : 2,
                          verticalOrigin : Cesium.VerticalOrigin.BOTTOM,
                          pixelOffset : new Cesium.Cartesian2(0, -9)
                      }
                  });
                }

             viewer.zoomTo(viewer.entities);

         }
    });
 };

 //*************************************************************
 //AJAX CALL TO RETRIEVE DEPOSIT COORDS FOR SELECTED COUNTY
 //*************************************************************
 var doAjax_deposits_by_county = function(state_county_ids) {
      //console.log("state_county_ids ", state_county_ids);
      var spt = state_county_ids.split(':')
      var state_id = parseInt(spt[0])
      var county_id = parseInt(spt[1])
      //console.log("state_id, county_id ", state_id, ' ', county_id);
      var deposit_ids = []
      var deposit_names = []
      var lats = []
      var lons = []
      var labels = []
      var descriptions = []
      var databases = []

      $.ajax({
         type: "GET",
         url: "http://127.0.0.1:5000/deposits_by_county/" + county_id + "/" + state_id,
         success: function(data) {
             objects = JSON.parse(data.Deposits)
             $.each(objects, function(i, object) {
                   country = object.country
                   //console.log('country ', country)
                   county = object.county
                   deposit_id = JSON.stringify(object.deposit_id)
                   deposit_name = object.deposit_name
                   state = object.state
                   pounds_u3o8 = object.pounds_u3o8
                   grade = object.grade
                   database = object.database_name

                   description = country
                   if (state) {
                      description =  state + ', ' + description
                   }
                   if (county) {
                      description =  county + ' County, ' + description
                   }

                   description =  description + ' :Grade = ' + grade + ': Pounds U3O8 = ' + pounds_u3o8 +': Database = ' + database

                   label = deposit_id + ': ' + deposit_name +
                     ': ' + county

                   deposit_ids.push(deposit_id);
                   deposit_names.push(deposit_name);
                   descriptions.push(description)
                   lats.push(object.latitude);
                   lons.push(object.longitude);
                   labels.push(label);
                   databases.push(database)
             });
         },
          complete: function(){

              $('#cesiumContainer').empty()

              Cesium.Ion.defaultAccessToken = '{{CESIUM_API_KEY}}';
              var viewer = new Cesium.Viewer('cesiumContainer');
              var showText_tf = false
              if  (usrMapLabels_yn == 'y'){
                showText_tf = true
              }

              for (var i = 0; i < deposit_names.length; i++) {
                   //console.log('labels[i] ', labels[i])
                   var myDistrict = viewer.entities.add({
                       name : labels[i],
                       position : Cesium.Cartesian3.fromDegrees(lons[i], lats[i]),
                       point : {
                           pixelSize : 5,
                           color : Cesium.Color.RED,
                           outlineColor : Cesium.Color.WHITE,
                           outlineWidth : 2
                       },
                       description: descriptions[i],
                       label : {
                           show: showText_tf,
                           text : deposit_names[i],
                           font : '14pt monospace',
                           style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                           outlineWidth : 2,
                           verticalOrigin : Cesium.VerticalOrigin.BOTTOM,
                           pixelOffset : new Cesium.Cartesian2(0, -9)
                       }
                   });
               }

              viewer.zoomTo(viewer.entities);

          }
      });
  };

  //*************************************************************
  //AJAX CALL TO RETRIEVE DEPOSIT COORDS FOR SELECTED DEPOSIT,
  //*************************************************************
  var doAjax_deposits_by_deposit = function(selected_ids) {
       //console.log("inputValue ", inputValue);
       var deposit_ids = []
       var deposit_names = []
       var lats = []
       var lons = []
       var labels = []
       var descriptions = []
       var states = []
       var databases = []
       var selected_id_str = ''

       $.each(selected_ids, function(i, selected_id) {
         selected_id_str = selected_id_str + selected_id + '!'
         //console.log("selected_id_str ", selected_id_str);
         });

       $.ajax({
          type: "GET",
          url: "http://127.0.0.1:5000/deposits_by_deposit/" + selected_id_str,
          success: function(data) {
              objects = JSON.parse(data.Deposits)
              $.each(objects, function(i, object) {
                    country = object.country
                    //console.log('country ', country)
                    county = object.county
                    deposit_id = JSON.stringify(object.deposit_id)
                    deposit_name = object.deposit_name
                    state = object.state
                    pounds_u3o8 = object.pounds_u3o8
                    grade = object.grade
                    database = object.database_name
                    description = country
                    if (state) {
                       description =  state + ', ' + description
                    }
                    if (county) {
                       description =  county + ' County, ' + description
                    }

                    description =  description + ' :Grade = ' + grade + ': Pounds U3O8 = ' + pounds_u3o8 + ' :Database = ' + database

                    label = deposit_id + ': ' + deposit_name

                    deposit_ids.push(deposit_id);
                    deposit_names.push(deposit_name);
                    descriptions.push(description)
                    lats.push(object.latitude);
                    lons.push(object.longitude);
                    labels.push(label);
                    //console.log("end of first ");
                    databases.push(database)

                    states.push(state)

              });
          },
           complete: function(){

               $('#cesiumContainer').empty()

               Cesium.Ion.defaultAccessToken = '{{CESIUM_API_KEY}}';
               var viewer = new Cesium.Viewer('cesiumContainer');
               var showText_tf = false
               if  (usrMapLabels_yn == 'y'){
                 showText_tf = true
               }

               for (var i = 0; i < deposit_names.length; i++) {
                    console.log('labels[i] ', labels[i])
                    var myDistrict = viewer.entities.add({
                        name : labels[i],
                        position : Cesium.Cartesian3.fromDegrees(lons[i], lats[i]),
                        point : {
                            pixelSize : 5,
                            color : Cesium.Color.RED,
                            outlineColor : Cesium.Color.WHITE,
                            outlineWidth : 2
                        },
                        description: descriptions[i],
                        label : {
                            show: showText_tf,
                            text : deposit_names[i],
                            font : '14pt monospace',
                            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                            outlineWidth : 2,
                            verticalOrigin : Cesium.VerticalOrigin.BOTTOM,
                            pixelOffset : new Cesium.Cartesian2(0, -9)
                        }
                    });
                }

               viewer.zoomTo(viewer.entities);

           }
      });
   };
});


</script>

{% endblock %}
