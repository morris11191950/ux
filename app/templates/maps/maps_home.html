{% extends 'base.html' %}

{% block title %}
     Maps
{% endblock %}

{% block subject %}
     <span id="title1">Maps</span>
{% endblock %}

{% block body %}

<select style="width:25%"; id="button_districts_map">
      <option></option>
</select>

<select style="width:25%"; id="button_counties_map">
      <option></option>
</select>

<div id="cesiumContainer"></div>

<script>

$(document).ready(function() {

  //*************************************************************
  //   AJAX CALL TO RETRIEVE DISTRICTS
  //*************************************************************
  $.ajax({
     type: "GET",
     url: "http://127.0.0.1:5000/districts_all",
     success: function(data) {
          objects = JSON.parse(data.Districts)
          $.each(objects, function(i, object) {
               $temp = "<option " + "value="  + object.district_id + ">"
                    + object.district_name + '</option>'
               //console.log('$temp ', $temp)
               $('#button_districts_map').append($temp);
          });
       }
   });

   //*************************************************************
   //   AJAX CALL TO RETRIEVE COUNTIES
   //*************************************************************
   $.ajax({
      type: "GET",
      url: "http://127.0.0.1:5000/counties_all",
      success: function(data) {
           objects = JSON.parse(data.Counties)
           $.each(objects, function(i, object) {
                var state_county = object.state + ' : ' + object.county
                var state_county_ids = object.state_id + ':' + object.county_id
                $temp = "<option " + "value="  + state_county_ids + ">"
                     + state_county + '</option>'
                //console.log('$temp ', $temp)
                $('#button_counties_map').append($temp);
           });
        }
    });


//*************************************************************
//   BY_DISTRICT SELECTION
//*************************************************************
$selectElement =  $("#button_districts_map").select2({
  placeholder : 'Select a District'
});

$("#button_districts_map").change(function() {
     var selected_id = $(this).children("option:selected").val();
     //console.log('selected_id', selected_id)
     doAjax_deposits_by_district(selected_id);
});

//*************************************************************
//   BY_COUNTY SELECTION
//*************************************************************
$selectElement =  $("#button_counties_map").select2({
  placeholder : 'Select a County'
});

$("#button_counties_map").change(function() {
     var selected_id = $(this).children("option:selected").val();
     //console.log('selected_id', selected_id)
     doAjax_deposits_by_county(selected_id);
});

//*************************************************************
//AJAX CALL TO RETRIEVE DEPOSIT COORDS FOR SELECTED DISTRICT,
//*************************************************************
var doAjax_deposits_by_district = function(inputValue) {
     //console.log("inputValue ", inputValue);
     var deposit_ids = []
     var deposit_names = []
     var lats = []
     var lons = []
     var labels = []
     var descriptions = []

     $.ajax({
        type: "GET",
        url: "http://127.0.0.1:5000/deposits_by_district/" + inputValue,
        success: function(data) {
            objects = JSON.parse(data.Deposits)
            $.each(objects, function(i, object) {
                  country = object.country
                  //console.log('country ', country)
                  county = object.county
                  deposit_id = JSON.stringify(object.deposit_id)
                  deposit_name = object.deposit_name
                  district_name = object.district_name
                  state = object.state
                  pounds_u3o8 = object.pounds_u3o8
                  grade = object.grade
                  description = country
                  if (state) {
                     description =  state + ', ' + description
                  }
                  if (county) {
                     description =  county + ' County, ' + description
                  }

                  description =  description + ' :Grade = ' + grade + ': Pounds U3O8 = ' + pounds_u3o8

                  label = deposit_id + ': ' + deposit_name +
                    ': ' + district_name

                  deposit_ids.push(deposit_id);
                  deposit_names.push(deposit_name);
                  descriptions.push(description)
                  lats.push(object.latitude);
                  lons.push(object.longitude);
                  labels.push(label);
                  //console.log("end of first ");

                  //states.push(state)

            });
        },
         complete: function(){

             $('#cesiumContainer').empty()

             Cesium.Ion.defaultAccessToken = '{{CESIUM_API_KEY}}';
             var viewer = new Cesium.Viewer('cesiumContainer');

             for (var i = 0; i < deposit_names.length; i++) {
                  //console.log('labels[i] ', labels[i])
                  var myDistrict = viewer.entities.add({
                      name : labels[i],
                      position : Cesium.Cartesian3.fromDegrees(lons[i], lats[i]),
                      point : {
                          pixelSize : 5,
                          color : Cesium.Color.RED,
                          outlineColor : Cesium.Color.WHITE,
                          outlineWidth : 2
                      },
                      description: descriptions[i],
                      label : {
                          //text : deposit_ids[i],
                          //text : deposit_names[i],
                          font : '14pt monospace',
                          style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                          outlineWidth : 2,
                          verticalOrigin : Cesium.VerticalOrigin.BOTTOM,
                          pixelOffset : new Cesium.Cartesian2(0, -9)
                      }
                  });
              }

             viewer.zoomTo(viewer.entities);

         }
      });
 };

 //*************************************************************
 //AJAX CALL TO RETRIEVE DEPOSIT COORDS FOR SELECTED COUNTY
 //*************************************************************
 var doAjax_deposits_by_county = function(state_county_ids) {
      //console.log("state_county_ids ", state_county_ids);
      var spt = state_county_ids.split(':')
      var state_id = parseInt(spt[0])
      var county_id = parseInt(spt[1])
      console.log("state_id, county_id ", state_id, ' ', county_id);
      var deposit_ids = []
      var deposit_names = []
      var lats = []
      var lons = []
      var labels = []
      var descriptions = []

      $.ajax({
         type: "GET",
         url: "http://127.0.0.1:5000/deposits_by_county/" + county_id + "/" + state_id,
         success: function(data) {
             objects = JSON.parse(data.Deposits)
             $.each(objects, function(i, object) {
                   country = object.country
                   //console.log('country ', country)
                   county = object.county
                   deposit_id = JSON.stringify(object.deposit_id)
                   deposit_name = object.deposit_name
                   state = object.state
                   pounds_u3o8 = object.pounds_u3o8
                   grade = object.grade
                   description = country
                   if (state) {
                      description =  state + ', ' + description
                   }
                   if (county) {
                      description =  county + ' County, ' + description
                   }

                   description =  description + ' :Grade = ' + grade + ': Pounds U3O8 = ' + pounds_u3o8

                   label = deposit_id + ': ' + deposit_name +
                     ': ' + county

                   deposit_ids.push(deposit_id);
                   deposit_names.push(deposit_name);
                   descriptions.push(description)
                   lats.push(object.latitude);
                   lons.push(object.longitude);
                   labels.push(label);
                   //console.log("end of first ");

                   //states.push(state)

             });
         },
          complete: function(){

              $('#cesiumContainer').empty()

              Cesium.Ion.defaultAccessToken = '{{CESIUM_API_KEY}}';
              var viewer = new Cesium.Viewer('cesiumContainer');

              for (var i = 0; i < deposit_names.length; i++) {
                   //console.log('labels[i] ', labels[i])
                   var myDistrict = viewer.entities.add({
                       name : labels[i],
                       position : Cesium.Cartesian3.fromDegrees(lons[i], lats[i]),
                       point : {
                           pixelSize : 5,
                           color : Cesium.Color.RED,
                           outlineColor : Cesium.Color.WHITE,
                           outlineWidth : 2
                       },
                       description: descriptions[i],
                       label : {
                           //text : deposit_ids[i],
                           //text : deposit_names[i],
                           font : '14pt monospace',
                           style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                           outlineWidth : 2,
                           verticalOrigin : Cesium.VerticalOrigin.BOTTOM,
                           pixelOffset : new Cesium.Cartesian2(0, -9)
                       }
                   });
               }

              viewer.zoomTo(viewer.entities);

          }
       });
  };


});


</script>

{% endblock %}
